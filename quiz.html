<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Safety Quiz</title>

  <!-- Supabase JS (shared scoreboard) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#120205; --card:rgba(135,7,28,0.12); --card2:rgba(135,7,28,0.18);
      --border:rgba(135,7,28,0.35); --text:#fcecee; --muted:rgba(252,236,238,0.82);
      --title:#ff4d6d; --title2:#ff8fa3; --accent:#87071c; --accent2:#a50922;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,sans-serif; color:var(--text);
      background: radial-gradient(1200px 500px at 20% 0%, rgba(135,7,28,0.35), transparent 60%),
                  radial-gradient(900px 500px at 100% 20%, rgba(135,7,28,0.22), transparent 55%),
                  var(--bg);
    }
    .wrap{max-width:980px;margin:0 auto;padding:44px 20px 70px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;color:var(--title);font-size:clamp(1.7rem,3vw,2.3rem);line-height:1.15}
    p{margin:10px 0;color:var(--muted)}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:18px;
      padding:22px; margin-top:18px; backdrop-filter:blur(6px)
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input{
      padding:12px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.05); color:var(--text); min-width:220px;
      outline:none;
    }
    input:focus{border-color:rgba(255,255,255,0.25)}
    .btn{
      display:inline-block; background:var(--accent); color:#fff; padding:12px 18px;
      border-radius:12px; text-decoration:none; font-weight:800; border:1px solid rgba(255,255,255,0.12);
      cursor:pointer;
    }
    .btn:hover{background:var(--accent2)}
    .btn-ghost{
      display:inline-block; padding:12px 18px; border-radius:12px; text-decoration:none;
      font-weight:800; color:var(--text);
      background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.14);
      cursor:pointer;
    }
    .btn-ghost:hover{background:rgba(255,255,255,0.06); border-color:rgba(255,255,255,0.22)}
    .q{
      background:var(--card2); border:1px solid rgba(135,7,28,0.45); border-radius:16px;
      padding:16px; margin-top:14px;
    }
    .q h2{margin:0 0 10px;color:var(--title2);font-size:1.1rem}
    .opt{
      width:100%; text-align:left; padding:12px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.14); background:rgba(255,255,255,0.05);
      color:var(--text); cursor:pointer; margin:8px 0; font-weight:650;
      transition: transform .15s, background .15s, border-color .15s;
    }
    .opt:hover{background:rgba(135,7,28,0.22); border-color:rgba(255,255,255,0.22); transform: translateY(-1px);}
    .ok{border-color:rgba(34,197,94,0.8)!important; background:rgba(34,197,94,0.12)!important}
    .bad{border-color:rgba(239,68,68,0.8)!important; background:rgba(239,68,68,0.12)!important}
    .picked{outline:2px solid rgba(255,255,255,0.22);}
    .muted{color:var(--muted); font-size:0.95rem}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,0.08); text-align:left}
    th{color:var(--title2); font-weight:800}
    @media (max-width:640px){ .top{gap:8px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>QR & Link Safety Quiz</h1>
      </div>
      <a class="btn-ghost" href="index.html">‚Üê Back</a>
    </div>

    <div class="card">
      <div class="row">
        <label for="name" class="muted" style="font-weight:700;">Enter a nickname:</label>
        <input id="name" maxlength="18" placeholder="e.g., Obeidat" />
        <button class="btn" id="startBtn" type="button">Start quiz</button>
      </div>
    </div>

    <div class="card" id="quizCard" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <div class="muted"><span id="playerLabel"></span> ‚Ä¢ Score: <b id="score">0</b>/<span id="total">0</span></div>
        <button class="btn-ghost" id="resetBtn" type="button">Reset</button>
      </div>

      <div id="questions"></div>

      <div class="row" style="margin-top:14px;">
        <button class="btn" id="finishBtn" type="button">Finish & Save Score</button>
      </div>

      <p id="msg" class="muted" style="margin-top:12px;"></p>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;color:var(--title2);">Shared scoreboard</h2>
      <p class="muted" style="margin:0;">Top 10 scores.</p>
      <div id="board"></div>
    </div>
  </div>

<script>
(() => {
  // Show any JS errors on the page (so you don't need DevTools)
  window.addEventListener("error", (e) => {
    const board = document.getElementById("board");
    if (board) {
      board.innerHTML =
        `<p class="muted" style="color:#f87171;font-weight:800;">
          JavaScript error: ${String(e.message || e.error || "Unknown")}
        </p>`;
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
    // =========================
    // Supabase (SAFE INIT)
    // =========================
    const SUPABASE_URL = "https://fagdpkcckpyhmmgmaqik.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_w3_sZUpV1LsChEuJGVWRnw_NLk17WPs";

    let supabaseClient = null;
    try {
      supabaseClient = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY) || null;
    } catch (_) {
      supabaseClient = null;
    }

    // =========================
    // Quiz questions
    // =========================
    const QUIZ = [
      {
        q: "What is the safest first step after scanning an unknown QR?",
        options: [
          "Open the link immediately",
          "Preview the URL and check the domain",
          "Share it with friends to confirm",
          "Turn off Wi-Fi and open it"
        ],
        correct: 1,
        explain: "Previewing the URL and checking the domain helps you spot look-alikes and short links."
      },
      {
        q: "Which link is the biggest red flag?",
        options: [
          "https://portal.university.edu",
          "https://uni.edu/events",
          "https://bit.ly/Verify-Uni-Now",
          "https://library.university.edu"
        ],
        correct: 2,
        explain: "Shortened links can hide the real destination. Be extra cautious."
      },
      {
        q: "A QR page instantly asks you to install an app to continue. What should you do?",
        options: [
          "Install it and delete later",
          "Close the page and don‚Äôt install anything",
          "Install if it has a logo",
          "Restart your phone then install"
        ],
        correct: 1,
        explain: "Unexpected app installs from QR scans are a common malware route."
      },
      {
        q: "HTTPS (the lock icon) means‚Ä¶",
        options: [
          "The site is definitely trustworthy",
          "The connection is encrypted, but the site could still be a scam",
          "The site is owned by your university",
          "The site is virus-free"
        ],
        correct: 1,
        explain: "HTTPS encrypts the connection, but scammers can also use HTTPS."
      }
    ];

    // =========================
    // DOM
    // =========================
    const nameInput = document.getElementById("name");
    const startBtn = document.getElementById("startBtn");
    const quizCard = document.getElementById("quizCard");
    const questionsEl = document.getElementById("questions");
    const scoreEl = document.getElementById("score");
    const totalEl = document.getElementById("total");
    const playerLabel = document.getElementById("playerLabel");
    const finishBtn = document.getElementById("finishBtn");
    const resetBtn = document.getElementById("resetBtn");
    const msg = document.getElementById("msg");
    const boardEl = document.getElementById("board");

    // If any of these are null, your HTML ids don't match (this will show you immediately)
    if (!nameInput || !startBtn || !quizCard || !questionsEl || !scoreEl || !totalEl || !playerLabel || !finishBtn || !resetBtn || !msg || !boardEl) {
      if (boardEl) boardEl.innerHTML = `<p class="muted" style="color:#f87171;font-weight:800;">Missing HTML element IDs. Check that id="startBtn", id="quizCard", etc. exist.</p>`;
      return;
    }

    totalEl.textContent = QUIZ.length;

    let answers = new Array(QUIZ.length).fill(null);
    let revealed = false;

    function sanitizeName(s){
      return (s || "").trim().replace(/\s+/g," ").slice(0,18);
    }

    function escapeHtml(s){
      return (s || "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      })[c]);
    }

    function renderQuestions(){
      questionsEl.innerHTML = "";
      QUIZ.forEach((item, i) => {
        const div = document.createElement("div");
        div.className = "q";
        div.innerHTML = `
          <h2>Q${i+1}. ${item.q}</h2>
          <div id="opts-${i}"></div>
          <div class="muted" id="exp-${i}" style="margin-top:8px;"></div>
        `;
        questionsEl.appendChild(div);

        const opts = div.querySelector(`#opts-${i}`);
        item.options.forEach((opt, idx) => {
          const btn = document.createElement("button");
          btn.className = "opt";
          btn.type = "button";
          btn.textContent = opt;
          btn.addEventListener("click", () => select(i, idx, btn, div));
          opts.appendChild(btn);
        });
      });
    }

    function select(qIndex, choice, btn, container){
      if (revealed) return;

      answers[qIndex] = choice;

      container.querySelectorAll(".opt").forEach(b => {
        b.classList.remove("ok","bad","picked");
      });

      btn.classList.add("picked");

      const exp = container.querySelector(`#exp-${qIndex}`);
      exp.textContent = "";

      updateScore();
    }

    function updateScore(){
      const score = answers.reduce((acc, a, i) => acc + (a === QUIZ[i].correct ? 1 : 0), 0);
      scoreEl.textContent = score;
      return score;
    }

    function revealAll(){
      revealed = true;

      QUIZ.forEach((item, i) => {
        const qBox = document.querySelectorAll(".q")[i];
        if(!qBox) return;

        const opts = qBox.querySelectorAll(".opt");
        const exp = qBox.querySelector(`#exp-${i}`);
        const correct = item.correct;
        const chosen = answers[i];

        opts.forEach(b => b.classList.remove("ok","bad","picked"));

        if(opts[correct]) opts[correct].classList.add("ok");
        if(chosen !== null && chosen !== correct && opts[chosen]) opts[chosen].classList.add("bad");

        exp.textContent = (chosen === correct ? "‚úÖ " : "‚ö†Ô∏è ") + item.explain;
      });
    }

    async function saveScore(name, score){
      if(!supabaseClient) return; // quiz still works even if Supabase fails
      const { error } = await supabaseClient
        .from("scores")
        .insert([{ name, score, total: QUIZ.length }]);
      if (error) throw error;
    }

    async function loadBoard(){
      if(!supabaseClient){
        boardEl.innerHTML = `<p class="muted">Leaderboard unavailable (Supabase didn‚Äôt load). Quiz still works.</p>`;
        return;
      }

      boardEl.innerHTML = `<p class="muted">Loading leaderboard‚Ä¶</p>`;

      const { data, error } = await supabaseClient
        .from("scores")
        .select("name, score, total, created_at")
        .order("score", { ascending: false })
        .order("created_at", { ascending: false })
        .limit(10);

      if (error || !data) {
        boardEl.innerHTML = `<p class="muted" style="color:#f87171;">Failed to load leaderboard.</p>`;
        return;
      }

      if (data.length === 0) {
        boardEl.innerHTML = `<p class="muted">No scores yet. Be the first üôÇ</p>`;
        return;
      }

      const rows = data.map((x, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${escapeHtml(x.name)}</td>
          <td><b>${x.score}</b> / ${x.total}</td>
          <td class="muted">${new Date(x.created_at).toLocaleString()}</td>
        </tr>
      `).join("");

      boardEl.innerHTML = `
        <table>
          <thead><tr><th>#</th><th>Nickname</th><th>Score</th><th>When</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    // ---- Start quiz (as a named function so we can force it if needed)
    function startQuiz(){
      // quick sanity check: if you click and see nothing, JS isn't running
      const name = sanitizeName(nameInput.value);
      if(!name){
        alert("Please enter a nickname.");
        return;
      }

      playerLabel.textContent = `Player: ${name}`;
      quizCard.style.display = "block";

      msg.textContent = "";
      msg.style.color = "";

      revealed = false;
      answers = new Array(QUIZ.length).fill(null);
      scoreEl.textContent = "0";

      renderQuestions();
      quizCard.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // Attach handlers (this is what was likely never happening)
    startBtn.addEventListener("click", startQuiz);
    nameInput.addEventListener("keydown", (e) => { if(e.key === "Enter") startQuiz(); });

    finishBtn.addEventListener("click", async () => {
      const name = sanitizeName(nameInput.value);
      if(!name){ alert("Please enter a nickname."); return; }

      if (answers.some(a => a === null)) {
        msg.textContent = "Answer all questions before saving your score.";
        msg.style.color = "#f87171";
        return;
      }

      revealAll();
      const score = updateScore();

      try{
        await saveScore(name, score);
        await loadBoard();
        msg.textContent = `Saved! ${name} scored ${score}/${QUIZ.length}.`;
        msg.style.color = "#4ade80";
      } catch {
        msg.textContent = "Could not save score (check Supabase table/RLS).";
        msg.style.color = "#f87171";
      }
    });

    resetBtn.addEventListener("click", () => {
      revealed = false;
      answers = new Array(QUIZ.length).fill(null);
      scoreEl.textContent = "0";
      msg.textContent = "";
      msg.style.color = "";
      renderQuestions();
    });

    // Load leaderboard on page load
    loadBoard();
  });
})();
</script>
</body>
</html>
